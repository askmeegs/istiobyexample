{"componentChunkName":"component---src-templates-example-js","path":"/databases/","webpackCompilationHash":"4c97b8867ce8cc5e8d2c","result":{"data":{"site":{"siteMetadata":{"title":"Istio By Example","author":"Megan O'Keefe"}},"markdownRemark":{"id":"d934f350-b71e-5d67-b799-c931c8b6998d","excerpt":"Applications often span multiple environments, and databases are a great example. You might choose to run your database outside of Kubernetes for legacy or‚Ä¶","html":"<p>Applications often span multiple environments, and databases are a great example. You might choose to run your database <a href=\"https://cloud.google.com/blog/products/databases/to-run-or-not-to-run-a-database-on-kubernetes-what-to-consider\">outside of Kubernetes</a> for legacy or storage reasons, or you might use a managed database service.</p>\n<p>But fear not! You can still add external databases to your Istio service mesh. Let‚Äôs see how.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/04b33c04eb17ac4c154c609022875b8b/ba4ff/diagram.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.52528602221854%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAJnKAACZygHjkaQiAAACLUlEQVQ4y5WTy27TQBSG89JIPAILVmxBbJB4AlasWbCoKlQpbZO0iRPq+BI7vo09Hl/m49hORUH0wkhHc5yMvnPO/P/MGJd9NHRtOb8w7P1uOmntGI+tWRRbXA/84EH44Mlvhwi+nxnevMv4+Fmhtf0D+q+Y3blQVj25qsmUJis0aaVJqgpVainW8v5TwZevFW17D+TxDsMQVJ1xVD5ZFZGaCB0cqbcxqi/GQ86OcfTf3fXYvsV2tYQ5RTN1GAgwLRPW3jVutMPZL6iuQtplSrp16RsP3y0wZgAKqFF00ZxeBZLn9CbDSvRVKHt+Dzyy9q8Jkj27/Yry0qfbFCRXN3TFHG+9Q2cRVgd0uUP57TX6xyswMSRLAayw6c1YYAQWVUZcBGTSaaJjTCoCrGNyuYpB6UGouu7G3DY1zeYDrfNW8gpbJ7IXUiyWPGXmyeGu7zGtptSF2MPlp78ll2p1o0eIJ6rX5mSwvpkAA+w07jjyAJY7HYF9P0luTMN2u+NwONBILnc/Ls+3Apx8+YTAk8rDyHlecDzGxHGMFwbotCQ7phRK/QV82oOjyuEBgSU4zobwEBIHEc15SDkPUKp8AORZD04+FGAcH1ktl4TRgWjj096kqAufPEjHQ3vvf4DyvLIs4e5uK2DpMAow4sNi7soLmoztBwKsXwgcXsHtumaxylgsM1brkltHy65YOzXDHV8uRLDmhcCus/JGB+ucQuw2fp9200z/36/ngL8ADFWH7FgjayIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"diagram\"\n        title=\"diagram\"\n        src=\"/static/04b33c04eb17ac4c154c609022875b8b/b9e4f/diagram.png\"\n        srcset=\"/static/04b33c04eb17ac4c154c609022875b8b/cf440/diagram.png 148w,\n/static/04b33c04eb17ac4c154c609022875b8b/d2d38/diagram.png 295w,\n/static/04b33c04eb17ac4c154c609022875b8b/b9e4f/diagram.png 590w,\n/static/04b33c04eb17ac4c154c609022875b8b/f9b6a/diagram.png 885w,\n/static/04b33c04eb17ac4c154c609022875b8b/2d849/diagram.png 1180w,\n/static/04b33c04eb17ac4c154c609022875b8b/ba4ff/diagram.png 6031w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>Here, we have a <code class=\"language-text\">plants</code> service running inside a Kubernetes cluster, with Istio enabled. <code class=\"language-text\">plants</code> writes inventory to a <a href=\"https://firebase.google.com/docs/firestore\">Firestore</a> NoSQL database running in Google Cloud, using the Golang client library for Firestore. Its logs look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">writing a new plant to Firestore<span class=\"token punctuation\">..</span>.\n‚úÖsuccess</code></pre></div>\n<p>Let‚Äôs say we want to monitor outgoing traffic to Firestore. To do this, we‚Äôll add an Istio <a href=\"https://istio.io/docs/reference/config/networking/v1alpha3/service-entry/\">ServiceEntry</a> corresponding to the hostname of the <a href=\"https://cloud.google.com/firestore/docs/reference/rpc/\">Firestore API</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.istio.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceEntry\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> firestore\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"firestore.googleapis.com\"</span>\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> https\n    <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">443</span>\n    <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> HTTPS\n  <span class=\"token key atrule\">location</span><span class=\"token punctuation\">:</span> MESH_EXTERNAL\n  <span class=\"token key atrule\">resolution</span><span class=\"token punctuation\">:</span> DNS</code></pre></div>\n<p>From here, we can see Firestore appear in Istio‚Äôs <a href=\"https://istio.io/docs/tasks/telemetry/kiali/\">service graph</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef259db8094d26ee52e769e902d4c25d/5b907/kiali-no-vs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.67043314500942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAwUlEQVQY052QzWrDMBCE/f4v0qfIoZfWVQ/GkCj4YIf+QOr84NiSLCuW/VVq6aXJIWRgdliYWdhJ+Id5ni94K6I38d5jrcUYgx/Hq8ZhGLB9jwvK5HFuoA97pHPuJx81IlFKIaXkRQjePj45+wnrzvQhrLWm7TqWK0kqXlnKNY/Pgqc0Jcsy8jynLEuKoqCu69+DcXg/0inNrumoA3cnxXZ/pKoqqs2Gr0PDoTWBmoeF4H0bwvN0/eV7uvoLh3nR9TeaAoKaMCX85AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kiali\"\n        title=\"kiali\"\n        src=\"/static/ef259db8094d26ee52e769e902d4c25d/b9e4f/kiali-no-vs.png\"\n        srcset=\"/static/ef259db8094d26ee52e769e902d4c25d/cf440/kiali-no-vs.png 148w,\n/static/ef259db8094d26ee52e769e902d4c25d/d2d38/kiali-no-vs.png 295w,\n/static/ef259db8094d26ee52e769e902d4c25d/b9e4f/kiali-no-vs.png 590w,\n/static/ef259db8094d26ee52e769e902d4c25d/f9b6a/kiali-no-vs.png 885w,\n/static/ef259db8094d26ee52e769e902d4c25d/5b907/kiali-no-vs.png 1062w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>Note that the traffic appears as TCP because the sidecar proxy for <code class=\"language-text\">plants</code> is receiving the firestore TLS traffic <a href=\"https://github.com/istio/istio/issues/14933\">as plain TCP</a>. The edge of the graph denotes the number of request throughput to Firestore, in bits per second.</p>\n<p>Now let‚Äôs say we want to test <code class=\"language-text\">plants</code>‚Äôs behavior when it cannot connect to the database. We can do this with Istio, without changing any application code.</p>\n<p>While Istio currently does not support TCP fault injection, what we can do is create a <a href=\"https://istio.io/docs/reference/config/networking/v1alpha3/virtual-service/#TCPRoute\">TCP traffic rule</a> to send firestore API traffic to another ‚Äúblack hole‚Äù service, effectively breaking the client connection to Firestore.</p>\n<p>To do this, we can deploy a small <code class=\"language-text\">echo</code> service inside the cluster, and forward all <code class=\"language-text\">firestore</code> traffic to the <code class=\"language-text\">echo</code> service instead:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.istio.io/v1alpha3\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> VirtualService\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fs\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> firestore.googleapis.com\n  <span class=\"token key atrule\">tcp</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">route</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> echo\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p>When we apply this Istio VirtualService to the cluster, the <code class=\"language-text\">plants</code> logs report errors:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">writing a new plant to Firestore<span class=\"token punctuation\">..</span>.\nüö´ Failed adding plant: rpc error: code <span class=\"token operator\">=</span> Unavailable desc <span class=\"token operator\">=</span> all SubConns are <span class=\"token keyword\">in</span> TransientFailure</code></pre></div>\n<p>And in the service graph, we can see that the <code class=\"language-text\">firestore</code> node has a purple <code class=\"language-text\">VirtualService</code> icon, meaning we‚Äôve applied an Istio traffic rule against that service. Eventually, throughput to Firestore will scale down to <code class=\"language-text\">0</code>, since we‚Äôve redirected all outgoing connections to the database.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/008f5f1c59fb77af16c1aeea0e230655/0309e/kiali.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAwklEQVQoz5VRbQuCMBj0//+qPvUxEiKQgkokdTab25wvc15TkZKs7ODg4XbP2O0cWLRtO+GozZ19YwdnHF4xGDAxLkHndcZBSgnOOXRdvxmLXPcsLdEApWqQiwpK1na2eqGfLxwv9H0fW9dFFBNo06LSDRhjCMMIwYXCPzF4e4LV+gBvF+LspQisFgcC5CrnI1e1RioUbpkA5RIkoUgIwV1wZEqB2hSb4wVFqX5H/uev+h2bouenUpY2aYwZlmca7vAA4L0lhYC56bsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kiali\"\n        title=\"kiali\"\n        src=\"/static/008f5f1c59fb77af16c1aeea0e230655/b9e4f/kiali.png\"\n        srcset=\"/static/008f5f1c59fb77af16c1aeea0e230655/cf440/kiali.png 148w,\n/static/008f5f1c59fb77af16c1aeea0e230655/d2d38/kiali.png 295w,\n/static/008f5f1c59fb77af16c1aeea0e230655/b9e4f/kiali.png 590w,\n/static/008f5f1c59fb77af16c1aeea0e230655/f9b6a/kiali.png 885w,\n/static/008f5f1c59fb77af16c1aeea0e230655/2d849/kiali.png 1180w,\n/static/008f5f1c59fb77af16c1aeea0e230655/0309e/kiali.png 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </a>\n    </span></p>\n<p>Note that you can also use Istio to manage traffic for databases <em>inside</em> the cluster, including Redis, SQL, and <a href=\"https://istio.io/blog/2018/egress-mongo/\">MongoDB</a>. <a href=\"https://istio.io/docs/setup/kubernetes/additional-setup/requirements/\">See the Istio docs</a> to learn more.</p>","frontmatter":{"title":"database traffic","date":"May 01, 2015"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/databases/","previous":null,"next":{"fields":{"slug":"/grpc/"},"frontmatter":{"title":"grpc"}}}}}