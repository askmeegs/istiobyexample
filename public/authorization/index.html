<!DOCTYPE html>
<html><meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Chivo|Fira+Code|Noto+Sans&display=swap" rel="stylesheet"><meta name="generator" content="Hugo 0.62.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light only">
<meta name="supported-color-schemes" content="light only"><title>Authorization&nbsp;&ndash;&nbsp;Istio By Example</title><link rel="stylesheet" href="/css/core.min.988c39bc0407abca60efde60cc162f7900ca228947877e93b72e80e2d7e1281beb7941359db3cc1efce23d5435dc05ae.css" integrity="sha384-mIw5vAQHq8pg795gzBYveQDKIolHh36Tty6A4tfhKBvreUE1nbPMHvziPVQ13AWu"><body>
<div class="base-body max-width">
<div id="content" class="flex-body max-body-width"><section id="header" class="header max-body-width"><p><a class="home" href="/"><img class="site-logo" src="/images/istio-logo.png" alt />
<span class="site-name">Istio By Example</span></a></p></section><h1 class="article-title">Authorization</h1>
</section>
<article class="markdown-body"><p>Authentication means verifying the identity of a client. <strong>Authorization</strong>, on the other hand, verifies the permissions of that client, or: &ldquo;can this service do what they're asking to do?&rdquo;</p>
<p>Kubernetes supports authorization through <strong>role-based access control</strong> (<a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#api-overview"target="_blank">RBAC</a>). In this model, you can map a <strong>role</strong> (a set of permissions) to a <strong>role binding</strong> (who exactly has these permissions?).</p>
<p><a href="https://istio.io/docs/concepts/security/#authorization"target="_blank">Istio uses RBAC</a> to allow you to set authorization policies between services in your cluster. Let's see how.</p>
<p>Here, the <em>ShoeStore</em> application is deployed to the <code>default</code> Kubernetes namespace. There are three services, and all speak plain HTTP:</p>
<ol>
<li><code>shoes</code>: exposes an API for all the shoes in the store</li>
<li><code>users</code>: stores purchase history</li>
<li><code>inventory</code>: loads new shoe models into <code>shoes</code>.</li>
</ol>
<p><a target="_blank" rel="noopener noreferrer" href="/images/rbac.png"><img class="img" src="/images/rbac.png" alt="shoes rbac"/></a></p>
<p>We want to authorize <code>inventory</code> to be able to <code>POST</code> new inventory to <code>shoes</code>, but not be able to access <code>users</code> at all. To do this, we will need three Istio resources.</p>
<p>First, we need to enable authorization for the <code>default</code> Kubernetes namespace:</p>
<div class="highlight"><pre class="chroma"><code class="language-YAML" data-lang="YAML">apiVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;rbac.istio.io/v1alpha1&#34;</span><span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ClusterRbacConfig<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>mode<span class="p">:</span><span class="w"> </span><span class="s1">&#39;ON_WITH_INCLUSION&#39;</span><span class="w">
</span><span class="w">  </span>inclusion<span class="p">:</span><span class="w">
</span><span class="w">    </span>namespaces<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;default&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></div><p>Second, we'll define our <code>ServiceRole</code>, the abstract set of permissions to <code>POST</code> data to the <code>shoes</code> service:</p>
<div class="highlight"><pre class="chroma"><code class="language-YAML" data-lang="YAML">apiVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;rbac.istio.io/v1alpha1&#34;</span><span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ServiceRole<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>shoes-user<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>rules<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>services<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;shoes.default.svc.cluster.local&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span>methods<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;POST&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></div><p>Lastly, we'll bind this abstract <code>shoes-user</code> role to a concrete set of <code>subjects</code> &ndash; in this case, any request that has the <code>hello:world</code> HTTP header.</p>
<div class="highlight"><pre class="chroma"><code class="language-YAML" data-lang="YAML">apiVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;rbac.istio.io/v1alpha1&#34;</span><span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ServiceRoleBinding<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>shoes-user-binding<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>subjects<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>properties<span class="p">:</span><span class="w">
</span><span class="w">      </span>request.headers<span class="p">[</span>hello<span class="p">]</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;world&#34;</span><span class="w">
</span><span class="w">  </span>roleRef<span class="p">:</span><span class="w">
</span><span class="w">    </span>kind<span class="p">:</span><span class="w"> </span>ServiceRole<span class="w">
</span><span class="w">    </span>name<span class="p">:</span><span class="w"> </span><span class="s2">&#34;shoes-user&#34;</span><span class="w">
</span></code></pre></div><p>From here, the <code>inventory</code> service can only make requests to <code>shoes</code> with the <code>hello:world</code> header, and the <code>users</code> service is still locked down. This is because RBAC is on, but we haven't assigned any <code>ServiceRoles</code> to access the <code>users</code> service.</p>
<p>To learn more:</p>
<ul>
<li><a href="https://istio.io/docs/tasks/security/authz-http/#step-2-allowing-access-to-the-details-and-reviews-services"target="_blank">Istio Authorization with Pod service accounts</a> (requires mutual TLS)</li>
<li><a href="https://istio.io/blog/2018/istio-authorization/#using-authenticated-client-identities"target="_blank">End-user authorization</a> through JWT claims</li>
<li><a href="https://istio.io/docs/tasks/security/authz-http/#enforcing-namespace-level-access-control"target="_blank">Namespace-level authorization</a></li>
</ul>
</article></div><section id="footer" class="footer max-body-width">
<p>Made with ❤️ by <a href="https://twitter.com/askmeegs">Megan O'Keefe</a> | <a href="https://github.com/askmeegs/istiobyexample">Source</a></p>
</section></div>
</body>
</html>